<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Soft Tennis Scorer V10 (Large Font)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* ================= Âç∞Âà∑Ë®≠ÂÆö ================= */
      @page {
        size: A4 portrait;
        margin: 0;
      }

      @media print {
        body > *:not(#ios-print-overlay) {
          display: none !important;
        }
        #ios-print-overlay {
          display: block !important;
          position: absolute !important;
          top: 0;
          left: 0;
          width: 100% !important;
          height: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
          background: white;
          z-index: 99999;
        }
        #print-content-clone {
          width: 100% !important;
          height: 100% !important;
          transform: none !important;
          box-shadow: none !important;
          border: none !important;
        }
      }
      #ios-print-overlay {
        display: none;
      }

      /* ================= UI„Çπ„Çø„Ç§„É´ ================= */
      body {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: #f8fafc;
        color: #334155;
        height: 100dvh;
        width: 100vw;
        overflow: hidden;
      }

      .screen {
        display: none;
        height: 100%;
        width: 100%;
        flex-direction: column;
        overflow: hidden;
        position: absolute;
        top: 0;
        left: 0;
      }
      .screen.active {
        display: flex;
      }

      input,
      select,
      textarea {
        font-size: 16px !important;
      }

      /* „Ç∏„É£„ÉÉ„Ç∏„Éö„Éº„Éë„ÉºÁΩ´Á∑ö */
      .b-r {
        border-right: 1px solid #000;
      }
      .b-b {
        border-bottom: 1px solid #000;
      }
      .b-l {
        border-left: 1px solid #000;
      }
      .b-t {
        border-top: 1px solid #000;
      }
      .b-b-dotted {
        border-bottom: 1px dotted #999;
      }
      .h-game {
        height: calc(100% * 2 / 15);
      }
      .h-final {
        height: calc(100% * 3 / 15);
      }
      .mark-o {
        font-size: 1.2rem;
        font-weight: bold;
        line-height: 1;
        display: block;
      }
      .mark-x {
        font-size: 1rem;
        line-height: 1;
        display: block;
      }

      .btn-press {
        transition:
          transform 0.05s,
          opacity 0.1s;
      }
      .btn-press:active {
        transform: scale(0.96);
        opacity: 0.9;
      }

      .bg-theme-a {
        background-color: #6366f1;
      }
      .bg-theme-b {
        background-color: #f43f5e;
      }
      .text-theme-a {
        color: #4338ca;
      }
      .text-theme-b {
        color: #be123c;
      }

      canvas {
        touch-action: none;
        cursor: crosshair;
      }
    </style>
  </head>
  <body class="safe-area-inset-bottom">
    <div id="screen-setup" class="screen active bg-slate-50">
      <div
        class="px-6 pt-10 pb-4 bg-white shadow-sm shrink-0 z-10 flex justify-between items-center"
      >
        <h1 class="text-xl font-bold text-slate-700">Match Setup</h1>
        <span
          id="resume-badge"
          class="hidden text-xs font-bold bg-amber-100 text-amber-700 px-3 py-1 rounded-full"
          >ÈÄ≤Ë°å‰∏≠</span
        >
      </div>

      <div class="flex-1 overflow-y-auto p-4 pb-32">
        <div
          class="mb-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-3"
        >
          <input
            type="text"
            id="setup-tourney"
            placeholder="Â§ß‰ºöÂêç"
            class="w-full border-b border-slate-100 p-2 focus:outline-none focus:border-indigo-500"
          />
          <div class="flex gap-3">
            <input
              type="date"
              id="setup-date"
              class="w-1/2 border-b border-slate-100 p-2 bg-transparent text-slate-500 focus:outline-none"
            />
            <input
              type="text"
              id="setup-court"
              placeholder="„Ç≥„Éº„ÉàNo"
              class="w-1/2 border-b border-slate-100 p-2 focus:outline-none focus:border-indigo-500"
            />
          </div>
          <input
            type="text"
            id="setup-category"
            placeholder="Á®ÆÂà• (‰æã: ‰∏ÄËà¨Áî∑Â≠ê)"
            class="w-full border-b border-slate-100 p-2 focus:outline-none focus:border-indigo-500"
          />
        </div>

        <div
          class="mb-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-3"
        >
          <input
            type="text"
            id="setup-umpire-m"
            placeholder="Ê≠£ÂØ©"
            class="w-1/2 border-b border-slate-100 p-2 text-center focus:outline-none focus:border-indigo-500"
          />
          <input
            type="text"
            id="setup-umpire-s"
            placeholder="ÂâØÂØ©"
            class="w-1/2 border-b border-slate-100 p-2 text-center focus:outline-none focus:border-indigo-500"
          />
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <div
            class="bg-white p-3 rounded-2xl border-t-4 border-indigo-500 shadow-sm"
          >
            <div class="text-center font-bold text-indigo-600 mb-2 text-sm">
              Team A
            </div>
            <input
              type="text"
              id="setup-p1"
              placeholder="ÈÅ∏Êâã1"
              class="w-full bg-slate-50 rounded p-2 mb-2 text-center text-sm"
            />
            <input
              type="text"
              id="setup-org1"
              placeholder="ÊâÄÂ±û"
              class="w-full bg-transparent border-b border-slate-100 p-1 mb-2 text-center text-xs"
            />
            <input
              type="text"
              id="setup-p2"
              placeholder="ÈÅ∏Êâã2"
              class="w-full bg-slate-50 rounded p-2 mb-2 text-center text-sm"
            />
            <input
              type="text"
              id="setup-org2"
              placeholder="ÊâÄÂ±û"
              class="w-full bg-transparent border-b border-slate-100 p-1 text-center text-xs"
            />
          </div>
          <div
            class="bg-white p-3 rounded-2xl border-t-4 border-rose-500 shadow-sm"
          >
            <div class="text-center font-bold text-rose-600 mb-2 text-sm">
              Team B
            </div>
            <input
              type="text"
              id="setup-p3"
              placeholder="ÈÅ∏Êâã3"
              class="w-full bg-slate-50 rounded p-2 mb-2 text-center text-sm"
            />
            <input
              type="text"
              id="setup-org3"
              placeholder="ÊâÄÂ±û"
              class="w-full bg-transparent border-b border-slate-100 p-1 mb-2 text-center text-xs"
            />
            <input
              type="text"
              id="setup-p4"
              placeholder="ÈÅ∏Êâã4"
              class="w-full bg-slate-50 rounded p-2 mb-2 text-center text-sm"
            />
            <input
              type="text"
              id="setup-org4"
              placeholder="ÊâÄÂ±û"
              class="w-full bg-transparent border-b border-slate-100 p-1 text-center text-xs"
            />
          </div>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm mb-4">
          <label
            class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center"
            >First Server</label
          >
          <div class="flex gap-3">
            <label
              class="flex-1 border-2 border-slate-100 rounded-xl p-3 flex flex-col items-center justify-center cursor-pointer transition has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50"
            >
              <input
                type="radio"
                name="first-server"
                value="A"
                checked
                class="hidden"
              />
              <span class="font-bold text-indigo-600">A</span>
            </label>
            <label
              class="flex-1 border-2 border-slate-100 rounded-xl p-3 flex flex-col items-center justify-center cursor-pointer transition has-[:checked]:border-rose-500 has-[:checked]:bg-rose-50"
            >
              <input
                type="radio"
                name="first-server"
                value="B"
                class="hidden"
              />
              <span class="font-bold text-rose-600">B</span>
            </label>
          </div>
        </div>

        <button
          onclick="forceReset()"
          id="btn-force-reset"
          class="hidden w-full text-red-400 font-bold py-3 text-sm"
        >
          „Éá„Éº„ÇøÂâäÈô§„ÉªÊñ∞Ë¶è‰ΩúÊàê
        </button>
      </div>

      <div
        class="p-4 bg-white border-t border-slate-100 absolute bottom-0 w-full pb-8 z-20"
      >
        <button
          onclick="handleStartButton()"
          id="btn-start-main"
          class="w-full bg-slate-800 text-white font-bold py-4 rounded-2xl shadow-lg btn-press text-lg"
        >
          Start Match
        </button>
      </div>
    </div>

    <div id="screen-game" class="screen bg-slate-100">
      <div class="bg-white shadow-sm z-10 shrink-0 pt-safe-top">
        <div class="flex justify-between items-center px-4 py-3">
          <button
            onclick="editSettings()"
            class="text-slate-400 p-2 rounded-lg border border-slate-200 text-xs font-bold"
          >
            ‚öô Ë®≠ÂÆö
          </button>
          <div
            class="font-bold text-sm bg-slate-800 text-white px-4 py-1 rounded-full"
          >
            GAME <span id="game-seq">1</span>
          </div>
        </div>

        <div class="px-4 pb-2">
          <div
            class="bg-white rounded-2xl p-2 shadow-sm border border-slate-200 flex items-end"
          >
            <div class="flex-1 text-center">
              <div
                class="text-5xl font-bold text-theme-a leading-none"
                id="game-point-a"
              >
                0
              </div>
              <div
                class="text-xs font-bold text-slate-500 truncate px-1"
                id="label-name-a-top"
              ></div>
            </div>
            <div class="pb-3 px-2">
              <div class="text-[10px] text-slate-400 font-bold text-center">
                G.COUNT
              </div>
              <div
                class="text-2xl font-mono font-bold flex items-center justify-center gap-2 bg-slate-100 rounded px-2"
              >
                <span id="game-gcount-a" class="text-indigo-500">0</span>
                <span class="text-slate-400">-</span>
                <span id="game-gcount-b" class="text-rose-500">0</span>
              </div>
            </div>
            <div class="flex-1 text-center">
              <div
                class="text-5xl font-bold text-theme-b leading-none"
                id="game-point-b"
              >
                0
              </div>
              <div
                class="text-xs font-bold text-slate-500 truncate px-1"
                id="label-name-b-top"
              ></div>
            </div>
          </div>
        </div>

        <div class="text-center pb-2">
          <span class="text-[10px] font-bold text-slate-400 uppercase mr-2"
            >Next Serve</span
          >
          <span
            id="server-indicator"
            class="font-bold text-sm bg-slate-200 px-3 py-0.5 rounded-full text-slate-600"
            >---</span
          >
        </div>
      </div>

      <div class="flex-1 p-3 flex flex-col gap-3 min-h-0">
        <div class="flex-1 flex gap-3">
          <button
            onclick="addPoint('A')"
            class="flex-1 bg-theme-a active:bg-indigo-600 text-white rounded-2xl shadow-lg flex flex-col items-center justify-center btn-press p-2 relative overflow-hidden group"
          >
            <span
              class="text-2xl font-bold w-full break-words leading-tight z-10"
              id="btn-name-a"
              >A</span
            >
            <span class="mt-1 text-[10px] bg-white/20 px-2 rounded-full z-10"
              >Point</span
            >
          </button>
          <button
            onclick="addPoint('B')"
            class="flex-1 bg-theme-b active:bg-rose-600 text-white rounded-2xl shadow-lg flex flex-col items-center justify-center btn-press p-2 relative overflow-hidden group"
          >
            <span
              class="text-2xl font-bold w-full break-words leading-tight z-10"
              id="btn-name-b"
              >B</span
            >
            <span class="mt-1 text-[10px] bg-white/20 px-2 rounded-full z-10"
              >Point</span
            >
          </button>
        </div>

        <div class="h-16 flex gap-3 shrink-0 mb-6">
          <button
            onclick="undoPoint()"
            class="flex-1 bg-white border border-slate-200 text-slate-500 font-bold rounded-xl shadow-sm btn-press text-sm"
          >
            ‚Ü©Ô∏é Undo
          </button>
          <button
            onclick="showPaper()"
            class="flex-1 bg-slate-700 text-white font-bold rounded-xl shadow-sm btn-press text-sm flex items-center justify-center gap-2"
          >
            üìÑ Check Paper
          </button>
        </div>

        <div
          id="match-finish-msg"
          class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3/4 bg-white/95 backdrop-blur p-6 rounded-2xl shadow-2xl border border-slate-100 text-center z-50"
        >
          <div class="text-4xl mb-4">üèÜ</div>
          <div class="text-xl font-bold text-slate-800 mb-1">
            Match Finished
          </div>
          <button
            onclick="openSignatureModal()"
            class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg"
          >
            ÂãùËÄÖÁΩ≤Âêç„Å∏ (Sign)
          </button>
        </div>
      </div>
    </div>

    <div id="screen-paper" class="screen bg-slate-800">
      <div
        class="bg-slate-900 p-3 pt-safe-top flex gap-3 shadow z-10 items-center justify-between shrink-0"
      >
        <button
          onclick="backToGame()"
          class="text-slate-300 px-3 py-2 font-bold text-sm flex items-center gap-1"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            ></path>
          </svg>
          Back
        </button>
        <div class="flex gap-2">
          <button
            onclick="openSignatureModal()"
            class="bg-slate-700 text-white px-3 py-2 rounded-full font-bold text-xs flex items-center gap-1 border border-slate-600"
          >
            üñäÔ∏è ÁΩ≤Âêç
          </button>
          <button
            onclick="startIOSPrint()"
            class="bg-blue-600 text-white px-5 py-2 rounded-full font-bold shadow-lg text-sm flex items-center gap-2"
          >
            üñ®Ô∏è Print
          </button>
        </div>
      </div>

      <div
        class="flex-1 overflow-hidden relative bg-slate-700 flex items-center justify-center"
      >
        <div
          id="preview-wrapper"
          class="origin-center transition-transform duration-300"
        >
          <div
            id="paper-source"
            class="bg-white w-[210mm] h-[297mm] shadow-2xl relative flex flex-col border border-black box-border px-6 py-6 text-xs text-black"
          >
            <div class="border-2 border-black w-full h-full flex flex-col">
              <div class="h-[8%] flex b-b">
                <div class="w-[70%] flex flex-col b-r">
                  <div class="h-1/2 b-b flex items-start p-1">
                    <span class="mr-2 w-10">Â§ß‰ºöÂêç</span
                    ><span id="out-tourney"></span>
                  </div>
                  <div class="h-1/2 flex">
                    <div class="w-1/3 b-r p-1">
                      Êó•‰ªò <span id="out-date"></span>
                    </div>
                    <div class="w-1/3 b-r p-1 flex">
                      „Ç≥„Éº„Éà <span id="out-court" class="ml-2 font-bold"></span>
                    </div>
                    <div class="w-1/3 p-1 flex">
                      Á®ÆÂà•
                      <span id="out-category" class="ml-2 font-bold"></span>
                    </div>
                  </div>
                </div>
                <div
                  class="w-[30%] p-1 flex items-center justify-center font-bold text-lg"
                >
                  <span id="out-gcount-a">0</span> -
                  <span id="out-gcount-b">0</span>
                </div>
              </div>
              <div class="h-[12%] flex b-b border-black">
                <div class="w-[42%] flex flex-col b-r">
                  <div class="h-1/2 b-b flex">
                    <div
                      class="w-6 b-r bg-gray-50 flex items-center justify-center"
                    >
                      No
                    </div>
                    <div class="flex-1 px-1 flex flex-col justify-center">
                      <span
                        id="out-p1"
                        class="font-bold text-xl leading-tight"
                      ></span
                      ><span
                        id="out-org1"
                        class="text-sm leading-tight text-gray-700"
                      ></span>
                    </div>
                  </div>
                  <div class="h-1/2 flex">
                    <div
                      class="w-6 b-r bg-gray-50 flex items-center justify-center"
                    >
                      No
                    </div>
                    <div class="flex-1 px-1 flex flex-col justify-center">
                      <span
                        id="out-p2"
                        class="font-bold text-xl leading-tight"
                      ></span
                      ><span
                        id="out-org2"
                        class="text-sm leading-tight text-gray-700"
                      ></span>
                    </div>
                  </div>
                </div>
                <div
                  class="w-[16%] b-r flex items-center justify-center relative bg-gray-50"
                >
                  <span class="text-2xl font-light opacity-20"
                    >( &nbsp;&nbsp;&nbsp; )</span
                  >
                  <span
                    id="out-final-score"
                    class="absolute text-xl font-bold text-black text-center leading-tight"
                  ></span>
                </div>
                <div class="w-[42%] flex flex-col">
                  <div class="h-1/2 b-b flex">
                    <div
                      class="w-6 b-r bg-gray-50 flex items-center justify-center"
                    >
                      No
                    </div>
                    <div class="flex-1 px-1 flex flex-col justify-center">
                      <span
                        id="out-p3"
                        class="font-bold text-xl leading-tight"
                      ></span
                      ><span
                        id="out-org3"
                        class="text-sm leading-tight text-gray-700"
                      ></span>
                    </div>
                  </div>
                  <div class="h-1/2 flex">
                    <div
                      class="w-6 b-r bg-gray-50 flex items-center justify-center"
                    >
                      No
                    </div>
                    <div class="flex-1 px-1 flex flex-col justify-center">
                      <span
                        id="out-p4"
                        class="font-bold text-xl leading-tight"
                      ></span
                      ><span
                        id="out-org4"
                        class="text-sm leading-tight text-gray-700"
                      ></span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex-1 flex w-full relative">
                <div class="flex-1 flex">
                  <div
                    id="col-sr-a"
                    class="w-6 b-r flex flex-col text-[8px] text-center"
                  ></div>
                  <div id="col-grid-a" class="flex-1 flex flex-col"></div>
                </div>
                <div
                  id="col-center"
                  class="w-16 b-l b-r flex flex-col border-black bg-gray-50"
                ></div>
                <div class="flex-1 flex">
                  <div id="col-grid-b" class="flex-1 flex flex-col"></div>
                  <div
                    id="col-sr-b"
                    class="w-6 b-l flex flex-col text-[8px] text-center"
                  ></div>
                </div>
              </div>
              <div class="h-[13%] b-t border-black flex flex-col">
                <div class="h-[50%] border-b border-black flex">
                  <div
                    class="w-[20%] b-r flex flex-col text-[10px] justify-center p-1"
                  >
                    <div class="flex justify-between border-b border-gray-300">
                      <span>ÈñãÂßã</span><span id="out-time-start"></span>
                    </div>
                    <div class="flex justify-between border-b border-gray-300">
                      <span>ÁµÇ‰∫Ü</span><span id="out-time-end"></span>
                    </div>
                    <div class="flex justify-between">
                      <span>ÊôÇÈñì</span><span></span>
                    </div>
                  </div>
                  <div class="w-[80%] flex flex-col">
                    <div class="h-1/2 flex b-b border-gray-400">
                      <div
                        class="w-10 b-r flex items-center justify-center font-bold text-[10px] truncate px-1"
                        id="footer-label-a"
                      >
                        A
                      </div>
                      <div id="footer-row-a" class="flex flex-1"></div>
                      <div
                        id="footer-total-a"
                        class="w-10 b-l flex items-center justify-center font-bold bg-gray-50"
                      >
                        0
                      </div>
                    </div>
                    <div class="h-1/2 flex">
                      <div
                        class="w-10 b-r flex items-center justify-center font-bold text-[10px] truncate px-1"
                        id="footer-label-b"
                      >
                        B
                      </div>
                      <div id="footer-row-b" class="flex flex-1"></div>
                      <div
                        id="footer-total-b"
                        class="w-10 b-l flex items-center justify-center font-bold bg-gray-50"
                      >
                        0
                      </div>
                    </div>
                  </div>
                </div>
                <div class="h-[50%] flex">
                  <div class="flex-1 b-r flex flex-col justify-end">
                    <div
                      id="out-umpire-m"
                      class="flex-1 flex items-center justify-center text-sm font-handwriting"
                    ></div>
                    <div class="text-center b-t py-1 text-[10px]">Ê≠£ÂØ©</div>
                  </div>
                  <div class="flex-1 b-r flex flex-col justify-end">
                    <div
                      id="out-umpire-s"
                      class="flex-1 flex items-center justify-center text-sm font-handwriting"
                    ></div>
                    <div class="text-center b-t py-1 text-[10px]">ÂâØÂØ©</div>
                  </div>
                  <div
                    class="flex-1 flex flex-col justify-end bg-yellow-50 relative"
                  >
                    <div
                      id="out-winner-sig-container"
                      class="absolute inset-0 pb-6 flex items-center justify-center overflow-hidden"
                    >
                      <img
                        id="out-winner-sig-img"
                        src=""
                        style="
                          display: none;
                          max-width: 100%;
                          max-height: 100%;
                          object-fit: contain;
                        "
                      />
                    </div>
                    <div
                      class="text-center b-t py-1 text-[10px] font-bold z-10 bg-yellow-50/50"
                    >
                      ÂãùËÄÖÁΩ≤Âêç
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="ios-print-overlay"></div>

    <div
      id="modal-signature"
      class="hidden fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center p-4"
    >
      <div
        class="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl flex flex-col"
      >
        <div
          class="bg-slate-100 p-3 border-b border-slate-200 flex justify-between items-center"
        >
          <span class="font-bold text-slate-700">Winner Signature</span>
          <button
            onclick="closeSignatureModal()"
            class="text-slate-400 font-bold text-xl px-2"
          >
            √ó
          </button>
        </div>
        <div
          class="relative bg-white w-full h-64 cursor-crosshair touch-none"
          id="canvas-container"
        >
          <canvas id="sig-canvas" class="w-full h-full"></canvas>
          <div
            class="absolute bottom-2 left-0 w-full text-center text-slate-200 text-sm pointer-events-none"
          >
            Sign Here
          </div>
        </div>
        <div class="p-4 bg-slate-50 border-t border-slate-200 flex gap-3">
          <button
            onclick="clearSignature()"
            class="flex-1 bg-white border border-slate-300 text-slate-600 font-bold py-3 rounded-xl"
          >
            Clear
          </button>
          <button
            onclick="saveSignature()"
            class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow"
          >
            Save & Apply
          </button>
        </div>
      </div>
    </div>

    <script>
      // === State ===
      const state = {
        games: [],
        history: [],
        matchFinished: false,
        winner: null,
        startTime: null,
        endTime: null,
        tourney: "",
        date: "",
        court: "",
        category: "",
        p1: "",
        org1: "",
        p2: "",
        org2: "",
        p3: "",
        org3: "",
        p4: "",
        org4: "",
        umpireM: "",
        umpireS: "",
        nameLabelA: "A",
        nameLabelB: "B",
        initialServer: "A",
        signatureData: null,
      };
      const MAX_HISTORY = 50;

      // === Signature ===
      let canvas,
        ctx,
        isDrawing = false;
      function initCanvas() {
        canvas = document.getElementById("sig-canvas");
        ctx = canvas.getContext("2d");
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";
        canvas.addEventListener("mousedown", startDraw);
        canvas.addEventListener("mousemove", moveDraw);
        canvas.addEventListener("mouseup", endDraw);
        canvas.addEventListener("mouseout", endDraw);
        canvas.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            startDraw(e.touches[0]);
          },
          { passive: false },
        );
        canvas.addEventListener(
          "touchmove",
          (e) => {
            e.preventDefault();
            moveDraw(e.touches[0]);
          },
          { passive: false },
        );
        canvas.addEventListener("touchend", (e) => {
          e.preventDefault();
          endDraw();
        });
      }
      function startDraw(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(
          (e.clientX || e.pageX) - rect.left,
          (e.clientY || e.pageY) - rect.top,
        );
      }
      function moveDraw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(
          (e.clientX || e.pageX) - rect.left,
          (e.clientY || e.pageY) - rect.top,
        );
        ctx.stroke();
      }
      function endDraw() {
        isDrawing = false;
      }
      function openSignatureModal() {
        document.getElementById("modal-signature").classList.remove("hidden");
        setTimeout(initCanvas, 100);
      }
      function closeSignatureModal() {
        document.getElementById("modal-signature").classList.add("hidden");
      }
      function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      function saveSignature() {
        state.signatureData = canvas.toDataURL("image/png");
        closeSignatureModal();
        if (
          document.getElementById("screen-paper").classList.contains("active")
        )
          updatePaperView();
        else showPaper();
      }

      // === Navigation ===
      function editSettings() {
        const hasPoints = state.games.some((g) => g.points.length > 0);
        const startBtn = document.getElementById("btn-start-main");
        const resetBtn = document.getElementById("btn-force-reset");
        const badge = document.getElementById("resume-badge");
        if (hasPoints) {
          startBtn.innerText = "Resume Match";
          resetBtn.classList.remove("hidden");
          badge.classList.remove("hidden");
        } else {
          startBtn.innerText = "Start Match";
          resetBtn.classList.add("hidden");
          badge.classList.add("hidden");
        }
        switchScreen("setup");
      }
      function handleStartButton() {
        saveSetupToState();
        const hasPoints = state.games.some((g) => g.points.length > 0);
        if (!hasPoints) initGameLogic();
        applyLabels();
        buildPaperDOM();
        updateGameScreen();
        switchScreen("game");
      }
      function forceReset() {
        if (confirm("ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
          state.signatureData = null;
          saveSetupToState();
          initGameLogic();
          applyLabels();
          buildPaperDOM();
          updateGameScreen();
          switchScreen("game");
        }
      }
      function saveSetupToState() {
        state.tourney = document.getElementById("setup-tourney").value;
        state.date = document.getElementById("setup-date").value;
        state.court = document.getElementById("setup-court").value;
        state.category = document.getElementById("setup-category").value;
        state.p1 = document.getElementById("setup-p1").value;
        state.org1 = document.getElementById("setup-org1").value;
        state.p2 = document.getElementById("setup-p2").value;
        state.org2 = document.getElementById("setup-org2").value;
        state.p3 = document.getElementById("setup-p3").value;
        state.org3 = document.getElementById("setup-org3").value;
        state.p4 = document.getElementById("setup-p4").value;
        state.org4 = document.getElementById("setup-org4").value;
        state.umpireM = document.getElementById("setup-umpire-m").value;
        state.umpireS = document.getElementById("setup-umpire-s").value;
        const radios = document.getElementsByName("first-server");
        for (let r of radios) {
          if (r.checked) state.initialServer = r.value;
        }
        state.nameLabelA =
          [state.p1, state.p2].filter(Boolean).join("„Éª") || "Team A";
        state.nameLabelB =
          [state.p3, state.p4].filter(Boolean).join("„Éª") || "Team B";
      }

      // === Logic ===
      function initGameLogic() {
        state.startTime = new Date().toLocaleTimeString("ja-JP", {
          hour: "2-digit",
          minute: "2-digit",
        });
        state.games = [];
        state.history = [];
        state.matchFinished = false;
        for (let i = 0; i < 7; i++)
          state.games.push({
            finished: false,
            winner: null,
            points: [],
            scoreA: 0,
            scoreB: 0,
          });
      }
      function addPoint(playerKey) {
        if (state.matchFinished) return;
        if (state.history.length >= MAX_HISTORY) state.history.shift();
        state.history.push(
          JSON.stringify({
            games: state.games,
            matchFinished: state.matchFinished,
            winner: state.winner,
          }),
        );
        const gameIdx = getCurrentGameIndex();
        if (gameIdx === -1) return;
        const game = state.games[gameIdx];
        game.points.push(playerKey);
        let pA = 0,
          pB = 0;
        game.points.forEach((p) => (p === "A" ? pA++ : pB++));
        game.scoreA = pA;
        game.scoreB = pB;
        const isFinal = gameIdx === 6;
        const target = isFinal ? 7 : 4;
        if (pA >= target && pA >= pB + 2) {
          game.finished = true;
          game.winner = "A";
        } else if (pB >= target && pB >= pA + 2) {
          game.finished = true;
          game.winner = "B";
        }
        checkMatchEnd();
        updateGameScreen();
      }
      function undoPoint() {
        if (state.history.length === 0) return;
        const prev = JSON.parse(state.history.pop());
        state.games = prev.games;
        state.matchFinished = prev.matchFinished;
        state.winner = prev.winner;
        updateGameScreen();
      }
      function checkMatchEnd() {
        let wA = 0,
          wB = 0;
        state.games.forEach((g) => {
          if (g.finished) g.winner === "A" ? wA++ : wB++;
        });
        if (wA === 4 || wB === 4) {
          state.matchFinished = true;
          state.winner = wA === 4 ? "A" : "B";
          state.endTime = new Date().toLocaleTimeString("ja-JP", {
            hour: "2-digit",
            minute: "2-digit",
          });
        }
      }
      function getCurrentGameIndex() {
        let wA = 0,
          wB = 0;
        for (let i = 0; i < 6; i++) {
          if (state.games[i].finished)
            state.games[i].winner === "A" ? wA++ : wB++;
        }
        if (wA === 4 || wB === 4) return -1;
        if (wA === 3 && wB === 3) return 6;
        return state.games.findIndex((g) => !g.finished);
      }
      function getNextServer(gameIdx, pointsCount) {
        if (gameIdx === -1) return "---";
        const firstServer = state.initialServer;
        const secondServer = firstServer === "A" ? "B" : "A";
        let currentSide = "";
        if (gameIdx < 6) {
          currentSide = gameIdx % 2 === 0 ? firstServer : secondServer;
        } else {
          const rot = Math.floor(pointsCount / 2);
          currentSide = rot % 2 === 0 ? firstServer : secondServer;
        }
        return currentSide === "A" ? state.nameLabelA : state.nameLabelB;
      }

      // === UI ===
      function applyLabels() {
        document.getElementById("btn-name-a").innerText = state.nameLabelA;
        document.getElementById("btn-name-b").innerText = state.nameLabelB;
        document.getElementById("label-name-a-top").innerText =
          state.nameLabelA;
        document.getElementById("label-name-b-top").innerText =
          state.nameLabelB;
        document.getElementById("footer-label-a").innerText = state.nameLabelA;
        document.getElementById("footer-label-b").innerText = state.nameLabelB;
      }
      function updateGameScreen() {
        let wA = 0,
          wB = 0;
        state.games.forEach((g) => {
          if (g.finished) g.winner === "A" ? wA++ : wB++;
        });
        document.getElementById("game-gcount-a").innerText = wA;
        document.getElementById("game-gcount-b").innerText = wB;
        const currentIdx = getCurrentGameIndex();
        const serverIndEl = document.getElementById("server-indicator");
        if (currentIdx !== -1) {
          const game = state.games[currentIdx];
          document.getElementById("game-seq").innerText =
            currentIdx === 6 ? "F" : currentIdx + 1;
          document.getElementById("game-point-a").innerText = game.scoreA;
          document.getElementById("game-point-b").innerText = game.scoreB;
          const srvName = getNextServer(currentIdx, game.points.length);
          serverIndEl.innerText = srvName;
          serverIndEl.className =
            srvName === state.nameLabelA
              ? "font-bold text-sm bg-indigo-100 text-indigo-700 px-3 py-0.5 rounded-full"
              : "font-bold text-sm bg-rose-100 text-rose-700 px-3 py-0.5 rounded-full";
          document.getElementById("match-finish-msg").classList.add("hidden");
        } else {
          document.getElementById("game-seq").innerText = "-";
          document.getElementById("game-point-a").innerText = "-";
          document.getElementById("game-point-b").innerText = "-";
          serverIndEl.innerText = "FINISH";
          serverIndEl.className =
            "font-bold text-sm bg-slate-200 text-slate-500 px-3 py-0.5 rounded-full";
          document
            .getElementById("match-finish-msg")
            .classList.remove("hidden");
        }
      }
      function showPaper() {
        updatePaperView();
        switchScreen("paper");
        setTimeout(fitPaperToScreen, 50);
      }
      function backToGame() {
        switchScreen("game");
      }
      function switchScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(`screen-${id}`).classList.add("active");
      }
      function fitPaperToScreen() {
        const screenW = window.innerWidth;
        const paperW = 210 * 3.78;
        const scale = Math.min((screenW - 20) / paperW, 1);
        document.getElementById("preview-wrapper").style.transform =
          `scale(${scale})`;
      }
      function startIOSPrint() {
        const source = document.getElementById("paper-source");
        const clone = source.cloneNode(true);
        clone.id = "print-content-clone";
        const overlay = document.getElementById("ios-print-overlay");
        overlay.innerHTML = "";
        overlay.appendChild(clone);
        window.print();
        setTimeout(() => {
          overlay.innerHTML = "";
        }, 1000);
      }
      function buildPaperDOM() {
        const ids = [
          "col-sr-a",
          "col-grid-a",
          "col-center",
          "col-grid-b",
          "col-sr-b",
          "footer-row-a",
          "footer-row-b",
        ];
        ids.forEach((id) => (document.getElementById(id).innerHTML = ""));
        for (let i = 0; i < 7; i++) {
          const isFinal = i === 6;
          const hClass = isFinal ? "h-final" : "h-game";
          document.getElementById("col-sr-a").innerHTML +=
            `<div id="sr-a-${i}" class="${hClass} b-b flex items-center justify-center relative"></div>`;
          document.getElementById("col-sr-b").innerHTML +=
            `<div id="sr-b-${i}" class="${hClass} b-b flex items-center justify-center relative"></div>`;
          const rows = isFinal ? 3 : 2;
          const makeGrid = (pid) => {
            let s = `<div class="${hClass} b-b flex flex-col">`;
            for (let r = 0; r < rows; r++) {
              s += `<div class="flex-1 flex border-gray-400 ${r < rows - 1 ? "b-b-dotted" : ""}">`;
              for (let c = 0; c < 16; c++)
                s += `<div id="cell-${pid}-${i}-${r}-${c}" class="flex-1 b-r border-gray-400 flex items-center justify-center"></div>`;
              s += `</div>`;
            }
            return s;
          };
          document.getElementById("col-grid-a").innerHTML += makeGrid("a");
          document.getElementById("col-grid-b").innerHTML += makeGrid("b");
          let centerC = isFinal
            ? `<div class="border border-black rounded-full w-5 h-5 flex items-center justify-center text-[10px] font-bold bg-white mb-0.5">F</div>`
            : `<div class="text-lg font-bold leading-none mb-0.5">${i + 1}</div>`;
          document.getElementById("col-center").innerHTML +=
            `<div class="${hClass} b-b flex flex-col items-center justify-center">${centerC}<div id="paper-score-${i}" class="w-10 h-3 border border-black bg-white flex items-center justify-center text-[8px] text-gray-300">( - )</div></div>`;
          document.getElementById("footer-row-a").innerHTML +=
            `<div id="sum-a-${i}" class="flex-1 b-r border-gray-400 flex items-center justify-center font-bold text-[10px]"></div>`;
          document.getElementById("footer-row-b").innerHTML +=
            `<div id="sum-b-${i}" class="flex-1 b-r border-gray-400 flex items-center justify-center font-bold text-[10px]"></div>`;
        }
      }
      function updatePaperView() {
        [
          "tourney",
          "date",
          "court",
          "category",
          "p1",
          "org1",
          "p2",
          "org2",
          "p3",
          "org3",
          "p4",
          "org4",
          "umpireM",
          "umpireS",
        ].forEach((k) => {
          const el = document.getElementById(`out-${k.toLowerCase()}`);
          if (el) el.innerText = state[k];
        });
        document.getElementById("out-umpire-m").innerText = state.umpireM;
        document.getElementById("out-umpire-s").innerText = state.umpireS;
        document
          .querySelectorAll('[id^="cell-"]')
          .forEach((e) => (e.textContent = ""));
        document
          .querySelectorAll('[id^="sr-"]')
          .forEach((e) => (e.textContent = ""));
        document
          .querySelectorAll('[id^="sum-"]')
          .forEach((e) => (e.textContent = ""));
        let wA = 0,
          wB = 0;
        state.games.forEach((g, idx) => {
          const isFinal = idx === 6;
          if (g.finished) g.winner === "A" ? wA++ : wB++;
          const sb = document.getElementById(`paper-score-${idx}`);
          if (g.points.length > 0) {
            sb.textContent = `(${g.scoreA}-${g.scoreB})`;
            sb.className =
              "w-10 h-3 border border-black bg-white flex items-center justify-center text-[8px] font-bold text-black";
          } else {
            sb.textContent = `( - )`;
            sb.className =
              "w-10 h-3 border border-black bg-white flex items-center justify-center text-[8px] text-gray-300";
          }
          if (g.points.length > 0) {
            const startSideName = getNextServer(idx, 0);
            const sideCode = startSideName === state.nameLabelA ? "a" : "b";
            const srEl = document.getElementById(`sr-${sideCode}-${idx}`);
            if (srEl) srEl.textContent = "S";
          }
          g.points.forEach((winner, pIdx) => {
            const row = Math.floor(pIdx / 16);
            const col = pIdx % 16;
            if (row >= (isFinal ? 3 : 2)) return;
            const cA = document.getElementById(`cell-a-${idx}-${row}-${col}`);
            const cB = document.getElementById(`cell-b-${idx}-${row}-${col}`);
            if (winner === "A") {
              if (cA) cA.innerHTML = '<span class="mark-o">‚óã</span>';
              if (cB) cB.innerHTML = '<span class="mark-x">√ó</span>';
            } else {
              if (cA) cA.innerHTML = '<span class="mark-x">√ó</span>';
              if (cB) cB.innerHTML = '<span class="mark-o">‚óã</span>';
            }
          });
          if (g.finished) {
            document.getElementById(`sum-a-${idx}`).textContent = g.scoreA;
            document.getElementById(`sum-b-${idx}`).textContent = g.scoreB;
          }
        });
        document.getElementById("out-gcount-a").textContent = wA;
        document.getElementById("out-gcount-b").textContent = wB;
        document.getElementById("footer-total-a").textContent = wA;
        document.getElementById("footer-total-b").textContent = wB;
        if (state.matchFinished) {
          const circled = ["0", "‚ë†", "‚ë°", "‚ë¢", "‚ë£", "‚ë§", "‚ë•", "‚ë¶"];
          const strA = wA <= 7 ? circled[wA] || wA : wA;
          const strB = wB <= 7 ? circled[wB] || wB : wB;
          document.getElementById("out-final-score").textContent =
            `${strA} - ${strB}`;
        } else {
          document.getElementById("out-final-score").textContent = "";
        }
        document.getElementById("out-time-start").textContent =
          state.startTime || "";
        document.getElementById("out-time-end").textContent =
          state.endTime || "";
        const sigImg = document.getElementById("out-winner-sig-img");
        if (state.signatureData) {
          sigImg.src = state.signatureData;
          sigImg.style.display = "block";
        } else {
          sigImg.style.display = "none";
        }
      }
      window.addEventListener("resize", () => {
        if (
          document.getElementById("screen-paper").classList.contains("active")
        ) {
          fitPaperToScreen();
        }
      });
    </script>
  </body>
</html>
